# Core vagrant configuration
VAGRANTFILE_API_VERSION = "2"

# Core machines configuration
# Reference: https://docs.mattermost.com/install/install-ubuntu.html
$box = "bento/ubuntu-20.04-arm64"
$vm_memory = 2048
$vm_cpus = 2

# Ansible provision configuration
$playbook = "ansible/playbook.yml"

manager = {
  :hostname => "manager",
  :box => $box,
  :ram => $vm_memory,
  :cpu => $vm_cpus
}

workers = [
    {
      :hostname => "worker-1",
      :box => $box,
      :ram => $vm_memory,
      :cpu => $vm_cpus
    },
    {
      :hostname => "worker-2",
      :box => $box,
      :ram => $vm_memory,
      :cpu => $vm_cpus
    }
]

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

    # Workaround for "SSH connection was unexpectedly closed by the remote end"
    # See: https://github.com/hashicorp/vagrant/issues/7681
    config.ssh.keep_alive = true

    # Configure worker machines
    workers.each do |machine|
        config.vm.define machine[:hostname] do |node|
            node.vm.box = machine[:box]
            node.vm.hostname = machine[:hostname]
            # Do not specify custom ip
            # See: https://developer.hashicorp.com/vagrant/docs/providers/vmware/known-issues
            node.vm.network "private_network"
            node.vm.provider "vmware_desktop" do |vmware|
                vmware.memory = machine[:ram]
                vmware.cpus = machine[:cpu]
            end
        end
    end

    # Configure cluster master machine
    config.vm.define manager[:hostname] do |node|
        node.vm.box = manager[:box]
        node.vm.hostname = manager[:hostname]
        # Do not specify custom ip
        # See: https://developer.hashicorp.com/vagrant/docs/providers/vmware/known-issues
        node.vm.network "private_network"
        node.vm.provider "vmware_desktop" do |vmware|
            vmware.memory = manager[:ram]
            vmware.cpus = manager[:cpu]
            vmware.allowlist_verified = true
        end

        # We don't want to install ansible on guest machines
        # so we're using plain ansible (not ansible_local)
        node.vm.provision "ansible" do |ansible|
            ansible.compatibility_mode = "1.8"
            ansible.playbook = $playbook
            ansible.limit = "all"
            ansible.groups = {
                "managers" => [manager[:hostname]],
                "workers"  => workers.map {
                    |worker| worker[:hostname]
                },
            }
            # Explicitly specify python3 interpreter
            ansible.extra_vars = {
                ansible_python_interpreter:"/usr/bin/python3"
            }
        end
    end
end
